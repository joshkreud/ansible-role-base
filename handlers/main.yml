---
- name: Restart sshd
  block:
    - name: Restart sshd or ssh
      become: true
      ansible.builtin.service:
        name: "{{ item }}"
        state: restarted
      loop:
        - sshd
        - ssh
      register: service_result
      ignore_errors: true

    - name: Check if any service restarted successfully
      ansible.builtin.fail:
        msg: "Failed to restart sshd or ssh"
      when: service_result.results | rejectattr('failed', 'defined') | list | length == 0

- name: Restart journald
  become: true
  ansible.builtin.service:
    name: systemd-journald
    state: restarted

- name: Restart ufw
  become: true
  community.general.ufw:
    state: reloaded

- name: Restart fail2ban
  become: true
  ansible.builtin.service:
    name: "fail2ban"
    state: "restarted"

- name: Reboot System
  become: yes
  ansible.builtin.reboot:
    reboot_timeout: 1800
  when: "'reboot' not in ansible_skip_tags"
